# üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è LogMonitor

* * *

## üîç –ì–ª–∞–≤–∞ 1: –ß—Ç–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏

### –¶–µ–ª—å –º–æ–¥—É–ª—è

–û–±–Ω–∞—Ä—É–∂–∏–≤–∞—Ç—å –Ω–æ–≤—ã–µ –∏ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –ª–æ–≥-—Ñ–∞–π–ª–∞—Ö, —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ (—Å–æ–¥–µ—Ä–∂–∞—â–∏–µ `ERR`), –∏—Å–∫–ª—é—á–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- `HybridFileWatcher` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- `IErrorDetectionService` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–æ–∫–∏ –Ω–∞ –æ—à–∏–±–∫—É
- `LogMonitoringHostedService` ‚Äî —Ñ–æ–Ω–æ–≤–∞—è —Å–ª—É–∂–±–∞ –∑–∞–ø—É—Å–∫–∞

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã

1. –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
    - –ß–∏—Ç–∞—é—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ `appsettings.json`: `Monitoring:LogDirectory`, `Monitoring:FileMasks`
    - –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `FilePositions`
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ –º–∞—Å–∫–µ:
    - –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ—Ç–æ–∫ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
    - –ß–∏—Ç–∞—é—Ç—Å—è –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏
3. –ö–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:
```cs
bool isErr = line.Contains("ERR", StringComparison.OrdinalIgnoreCase);
```

1. –î–ª—è –Ω–æ–≤—ã—Ö –æ—à–∏–±–æ–∫:
    - –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è `SHA256(Content)` ‚Üí `ContentHash`
    - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–∞ –ø–æ:
        - `(FileName + LinePosition)` **–ò–õ–ò**
        - `ContentHash`
    - –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `Errors` –∏ `Notifications`
    - –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `LastPosition` –≤ `FilePositions`

### –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è

- **–¢–æ—á–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è**: –¥–∞–∂–µ –µ—Å–ª–∏ —Ñ–∞–π–ª –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω ‚Äî –¥—É–±–ª–∏–∫–∞—Ç –Ω–µ –ø—Ä–æ–π–¥—ë—Ç
- **–ö–æ–Ω—Ç–µ–Ω—Ç-—Ö–µ—à**: –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∞—Å—å –≤ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª/—Å—Ç—Ä–æ–∫—É ‚Äî –æ–Ω–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –¥—É–±–ª–∏–∫–∞—Ç–æ–º

### –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

- –ü—Ä–∏ —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–∞ (—Ñ–∞–π–ª —É–º–µ–Ω—å—à–∏–ª—Å—è) ‚Äî –ø–æ–∑–∏—Ü–∏—è —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞—Ç–æ–º–∞—Ä–Ω—ã —á–µ—Ä–µ–∑ `SaveChangesAsync()`

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ (—á—Ç–µ–Ω–∏–µ —Å `FileShare.ReadWrite`)
- PostgreSQL (—Ç–∞–±–ª–∏—Ü—ã `Errors`, `Notifications`, `FilePositions`)

* * *

## üì° –ì–ª–∞–≤–∞ 2: –†–∞–±–æ—Ç–∞ —Å SignalR Hub –∏ REST API

### –¶–µ–ª—å –º–æ–¥—É–ª—è

–û–±–µ—Å–ø–µ—á–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è:

- –ü–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –æ—à–∏–±–æ–∫ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (REST)
- –ü–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (SignalR)

### REST API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
| –ú–µ—Ç–æ–¥ | –≠–Ω–¥–ø–æ–∏–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ | –û—Ç–≤–µ—Ç |
| --- | --- | --- | --- |
| `GET` | `/api/errors` | –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ | `List<ErrorDto>` |
| `GET` | `/api/notifications` | –°–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π | `List<NotificationDto>` |
| `POST` | `/api/configure` | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–∑–∞–≥–ª—É—à–∫–∞) | `{ success: true }` |
| `PATCH` | `/api/notifications/{id}/read` | –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ | `{ isRead: true }` |

#### DTO
```cs
public record ErrorDto(int Id, string FileName, string Content, long LinePosition, DateTime CreatedAt);
public record NotificationDto(int Id, int ErrorId, DateTime SentAt, bool IsRead, bool EmailSent, bool TelegramSent);
```

### SignalR Hub

- **–ü—É—Ç—å**: `/errorhub`
- **–ú–µ—Ç–æ–¥ –ø–æ–¥–ø–∏—Å–∫–∏**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è (–±–µ–∑ —è–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏)
- **–°–æ–±—ã—Ç–∏–µ**: `ReceiveError(ErrorDto)`
- **–¢–∏–ø –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**: `HubConnection` (WebSocket –∏–ª–∏ SSE)

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–ª–∞—Å—Å—ã

- `ErrorsController`, `NotificationsController`
- `ErrorNotificationHub : Hub`
- `INotificationRouter` ‚Äî –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

1. `HybridFileWatcher` –Ω–∞—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫—É
2. –í—ã–∑—ã–≤–∞–µ—Ç `INotificationRouter.RouteErrorAsync(errorDto)`
3. `NotificationRouter`:
    - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —á–µ—Ä–µ–∑ `IHubContext.Clients.All.SendAsync("ReceiveError", dto)`
    - –ó–∞–ø—É—Å–∫–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –≤ Telegram (–æ—Ç–¥–µ–ª—å–Ω–æ)

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ù–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–¥–ª—è –¥–µ–º–æ)
- –í production ‚Äî –¥–æ–±–∞–≤–∏—Ç—å `[Authorize]` –∏ JWT

* * *

## ü§ñ –ì–ª–∞–≤–∞ 3: –†–∞–±–æ—Ç–∞ —Å Telegram-–±–æ—Ç–æ–º

### –¶–µ–ª—å –º–æ–¥—É–ª—è

–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö –≤ Telegram **—Ç–æ–ª—å–∫–æ —Ç–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å** —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É `/start`.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

#### 1. –ü–æ–¥–ø–∏—Å–∫–∞ (`/start`)

- **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç**: `TelegramPollingService` (—Ñ–æ–Ω–æ–≤–∞—è —Å–ª—É–∂–±–∞)
- **–ú–µ—Ç–æ–¥**: –æ–ø—Ä–æ—Å `https://api.telegram.org/bot{token}/getUpdates`
- **–ò–Ω—Ç–µ—Ä–≤–∞–ª**: 2 —Å–µ–∫—É–Ω–¥—ã
- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è**: —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ç–µ–∫—Å—Ç–æ–º `/start`
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**: `chat_id` ‚Üí —Ç–∞–±–ª–∏—Ü–∞ `TelegramSubscribers`

#### 2. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

- **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç**: `TelegramService`
- **–ú–µ—Ç–æ–¥**: `POST https://api.telegram.org/bot{token}/sendMessage`
- **–ü–æ–ª—É—á–∞—Ç–µ–ª–∏**: –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏–∑ `TelegramSubscribers` —Å `ChatId > 0`
- **–ü–æ–≤—Ç–æ—Ä—ã**: –¥–æ 3 –ø–æ–ø—ã—Ç–æ–∫ (1s ‚Üí 2s ‚Üí 4s)
- **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î**: `TelegramSent = true` –ø—Ä–∏ —É—Å–ø–µ—Ö–µ

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```json
{
  "Telegram": {
    "IsEnabled": true,
    "BotToken": "123456:ABC...",
    "ChatId": null  // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ –ø–æ–¥–ø–∏—Å–∫–∏
  }
}
```

> 
> üîí **–°–µ–∫—Ä–µ—Ç—ã** –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ `TELEGRAM__BOTTOKEN` –∏ `TELEGRAM__CHATID`

### –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
```
üö® –ù–æ–≤–∞—è –æ—à–∏–±–∫–∞ –≤ –ª–æ–≥–µ!
–§–∞–π–ª: {FileName}
–í—Ä–µ–º—è: {CreatedAt:yyyy-MM-dd HH:mm:ss}
–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:
{Content}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

- **NTA/–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞**: –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ `Warning`, –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É
- **–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω/—á–∞—Ç**: –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ `Error`, –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
- **–°–µ—Ç–µ–≤–æ–π —Ç–∞–π–º–∞—É—Ç**: –ø–æ–≤—Ç–æ—Ä –¥–æ 3 —Ä–∞–∑

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Telegram

- –ë–æ—Ç **–Ω–µ –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å –ø–µ—Ä–≤—ã–º** –≤ –ª–∏—á–∫—É ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ `/start`
- –í –≥—Ä—É–ø–ø—É ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ –∞–¥–º–∏–Ω —Å –ø—Ä–∞–≤–æ–º –æ—Ç–ø—Ä–∞–≤–∫–∏

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- –î–æ—Å—Ç—É–ø –∫ `api.telegram.org` (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –≤ –ù–µ–ø–∞–ª–µ)
- –¢–∞–±–ª–∏—Ü–∞ `TelegramSubscribers` –≤ –ë–î

### –¢–∞–±–ª–∏—Ü–∞ –ë–î
```sql
CREATE TABLE "TelegramSubscribers" (
    "ChatId" BIGINT PRIMARY KEY,
    "FirstName" TEXT,
    "Username" TEXT,
    "SubscribedAt" TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

## üìÅ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### appsettings.json (—Ñ—Ä–∞–≥–º–µ–Ω—Ç)
```json
{
  "Monitoring": {
    "LogDirectory": "D:\\logs",
    "FileMasks": ["*.log"]
  },
  "Telegram": {
    "IsEnabled": true
  }
}
```

### –ü—Ä–∏–º–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è SignalR (JavaScript)
```js
const conn = new signalR.HubConnectionBuilder()
    .withUrl("http://localhost:5000/errorhub")
    .build();

conn.on("ReceiveError", err => console.log("üö®", err));
conn.start();
```

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ Telegram-–±–æ—Ç—É

1. –°–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ [@BotFather<svg width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><use xlink:href="#icon-line-arrow-up-right"></use></svg>](https://t.me/BotFather)
2. –î–ª—è –ª–∏—á–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª `/start`
3. –î–ª—è –≥—Ä—É–ø–ø ‚Äî –±–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∫–∞–∫ –∞–¥–º–∏–Ω —Å –ø—Ä–∞–≤–æ–º –æ—Ç–ø—Ä–∞–≤–∫–∏

* * *
